# /etc/nginx/sites-available/d.wedding.love
# Frontend: d.wedding.love + *.d.wedding.love
# Flow: Client -> Cloudflare (SSL) -> Nginx -> Next.js (127.0.0.1:3000)
# Optional: proxy /api -> weding-backend.hoangdieuit.vn (uncomment block if want)

# Upstream for Next.js
upstream frontend {
    server 127.0.0.1:3000;
    keepalive 64;
}

# Optional upstream for backend (if you want Nginx to proxy API)
# upstream backend_up {
#     server weding-backend.hoangdieuit.vn:443;  # if using HTTPS on backend
#     keepalive 32;
# }

server {
    listen 80;
    listen 443 ssl http2;
    server_name d.wedding.love *.d.wedding.love;

    # Cloudflare Origin Certificate files (create from Cloudflare dashboard)
    ssl_certificate /etc/nginx/ssl/cloudflare-origin.pem;
    ssl_certificate_key /etc/nginx/ssl/cloudflare-origin-key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # --------------------
    # Trust Cloudflare IP ranges (so $remote_addr becomes real client IP)
    # --------------------
    real_ip_header CF-Connecting-IP;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;

    # --------------------
    # Extract tenant subdomain (first label) -> X-Subdomain
    # - d.wedding.love -> subdomain = ""
    # - demo.d.wedding.love -> subdomain = "demo"
    # --------------------
    set $subdomain "";
    if ($host ~* ^([a-z0-9-]+)\.d\.wedding\.love$) {
        set $subdomain $1;
    }

    # Treat common system subdomains as empty
    if ($subdomain = "www") { set $subdomain ""; }
    if ($subdomain = "api") { set $subdomain ""; }
    if ($subdomain = "mail") { set $subdomain ""; }
    if ($subdomain = "ftp") { set $subdomain ""; }

    # --------------------
    # Security headers
    # --------------------
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # --------------------
    # Basic optimizations
    # --------------------
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    client_max_body_size 50M;

    # ========================================
    # Serve Next.js static assets (immutable)
    # ========================================
    location ~ ^/_next/static/ {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Static assets are immutable (contain hashes)
        add_header Cache-Control "public, immutable, max-age=31536000";
        expires 1y;
        access_log off;
    }

    # Optionally serve /static or /public directly from disk if you put files there:
    # location /static/ {
    #     root /var/www/d.wedding.love;   # adjust path if you store static files
    #     access_log off;
    #     add_header Cache-Control "public, max-age=86400";
    # }

    # ========================================
    # Optional: Proxy /api to external backend
    # If you want Nginx to forward API calls to backend domain, uncomment this.
    # Make sure backend allows Cloudflare or your server IP and CORS is set if needed.
    # ========================================
    # location /api/ {
    #     proxy_pass https://weding-backend.hoangdieuit.vn;   # backend domain (HTTPS)
    #     proxy_http_version 1.1;
    #     proxy_set_header Host $host;                       # or set to weding-backend.hoangdieuit.vn
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header X-Forwarded-Host $host;
    #     proxy_set_header X-Forwarded-Port $server_port;
    #     proxy_set_header X-Forwarded-Ssl on;
    #     proxy_ssl_server_name on;
    #     proxy_read_timeout 120s;
    #     proxy_connect_timeout 10s;
    #     proxy_send_timeout 10s;
    #     proxy_set_header Host weding-backend.hoangdieuit.vn;
    # }

    # ========================================
    # Websocket / all other routes -> Next.js
    # ========================================
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Subdomain $subdomain;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Healthcheck (useful for load balancers or monitoring)
    location = /healthz {
        return 200 'ok';
        add_header Content-Type text/plain;
    }
}

# Default server - reject unknown hosts (safety)
server {
    listen 80 default_server;
    listen 443 ssl http2 default_server;
    server_name _;

    ssl_certificate /etc/nginx/ssl/cloudflare-origin.pem;
    ssl_certificate_key /etc/nginx/ssl/cloudflare-origin-key.pem;

    return 444;
}