# Nginx configuration for Wedding Innovation - FRONTEND SERVER
# Flow: Cloudflare -> Nginx -> Next.js
# Backend is on a DIFFERENT server (api.hoangdieuit.io.vn)
# Cloudflare handles SSL termination & wildcard DNS

# Upstream for Next.js frontend (same server)
upstream frontend {
    server 127.0.0.1:3000;
    keepalive 64;
}

# NOTE: Backend is on different server
# Frontend calls backend directly via: https://api.hoangdieuit.io.vn
# No need to proxy /api or /static through this nginx

# ========================================
# Single server block for all domains
# hoangdieuit.io.vn + *.hoangdieuit.io.vn
# ========================================
server {
    listen 80;
    listen 443 ssl http2;
    
    # Handle main domain + all subdomains
    server_name hoangdieuit.io.vn *.hoangdieuit.io.vn;

    # Cloudflare Origin Certificate
    # Create at: Cloudflare Dashboard > SSL/TLS > Origin Server > Create Certificate
    ssl_certificate /etc/nginx/ssl/cloudflare-origin.pem;
    ssl_certificate_key /etc/nginx/ssl/cloudflare-origin-key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Trust Cloudflare IPs for real client IP
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    real_ip_header CF-Connecting-IP;

    # Extract subdomain from host
    # hoangdieuit.io.vn -> subdomain = ""
    # demo-wedding.hoangdieuit.io.vn -> subdomain = "demo-wedding"
    set $subdomain "";
    if ($host ~* ^([a-z0-9-]+)\.hoangdieuit\.io\.vn$) {
        set $subdomain $1;
    }

    # Clear subdomain for system subdomains (www, api, mail, etc.)
    set $is_system 0;
    if ($subdomain = "www") { set $is_system 1; set $subdomain ""; }
    if ($subdomain = "api") { set $is_system 1; set $subdomain ""; }
    if ($subdomain = "mail") { set $is_system 1; set $subdomain ""; }
    if ($subdomain = "ftp") { set $is_system 1; set $subdomain ""; }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml image/svg+xml;

    # Client max body size for uploads
    client_max_body_size 50M;

    # ========================================
    # Next.js static files (immutable cache)
    # ========================================
    location /_next/static {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        
        # Immutable cache - files have hash in name
        add_header Cache-Control "public, immutable, max-age=31536000";
    }

    # ========================================
    # All other routes -> Next.js with X-Subdomain
    # ========================================
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Subdomain $subdomain;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}

# ========================================
# Default server - reject unknown hosts
# ========================================
server {
    listen 80 default_server;
    listen 443 ssl http2 default_server;
    server_name _;

    ssl_certificate /etc/nginx/ssl/cloudflare-origin.pem;
    ssl_certificate_key /etc/nginx/ssl/cloudflare-origin-key.pem;

    # Close connection without response
    return 444;
}
